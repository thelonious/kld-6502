let DFARunner = require('kld-regex').DFARunner;

let tokens = [
    /*  0 */ { type: "whitespace",   pattern: "[\\ \\t]+" },
    /*  1 */ { type: "eol",          pattern: "(\\r\\n|\\r|\\n)"},
    /*  2 */ { type: "comment",      pattern: ";[^\\r\\n]*" },
    /*  3 */ { type: "mnemonic",     pattern: "(adc|and|asl|bcc|bcs|beq|bit|bmi|bne|bpl|brk|bvc|bvs|clc|cld|cli|clv|cmp|cpx|cpy|dec|dex|dey|eor|inc|inx|iny|jmp|jsr|lda|ldx|ldy|lsr|nop|ora|pha|php|pla|plp|rol|ror|rti|rts|sbc|sec|sed|sei|sta|stx|sty|tax|tay|tsx|txa|txs|tya)", caseSensitive: false },
    /*  4 */ { type: "directive",    pattern: "\\.(ascii|db|ds|dw|include|org)", caseSensitive: false },
    /*  5 */ { type: "equate",       pattern: "(\\.equ?|=)", caseSensitive: false },
    /*  6 */ { type: "lowByte",      pattern: "\\.l(ow)?", caseSensitive: false },
    /*  7 */ { type: "highByte",     pattern: "\\.h(igh)?", caseSensitive: false },
    /*  8 */ { type: "accumulator",  pattern: "a", caseSensitive: false },
    /*  9 */ { type: "register",     pattern: "(x|y)", caseSensitive: false },
    /* 10 */ { type: "colon",        pattern: ":" },
    /* 11 */ { type: "comma",        pattern: "," },
    /* 12 */ { type: "pound",        pattern: "#" },
    /* 13 */ { type: "lparen",       pattern: "\\(" },
    /* 14 */ { type: "rparen",       pattern: "\\)" },
    /* 15 */ { type: "charConstant", pattern: "'.'" },
    /* 16 */ { type: "charString",   pattern: "\\\".+\\\"" },
    /* 17 */ { type: "binaryNumber", pattern: "%[01]+" },
    /* 18 */ { type: "hexNumber",    pattern: "\\$[a-f0-9]+", caseSensitive: false },
    /* 19 */ { type: "number",       pattern: "-?(0|[1-9][0-9]*)" },
    /* 20 */ { type: "plus",         pattern: "\\+" },
    /* 21 */ { type: "times",        pattern: "\\*" },
    /* 22 */ { type: "identifier",   pattern: "[a-z_][a-z0-9_]*", caseSensitive: false }
];

let table = [
  [ [-9,1,2,-2,3,-18,1,-1,4,5,6,7,-1,8,9,10,11,12,13,14,15,-1,16,2321,18,19,-1,20,-3,21,22,23,24,25,794,27,28,26,29,26,30,31,32,26,33,34,35,794,36,37,26,-4,26,-1,21,22,23,24,25,794,27,28,26,29,26,30,31,32,26,33,34,35,794,36,37,26,-133], -1 ],
  [ [-9,1,-22,1,-223], 0 ],
  [ [-256], 1 ],
  [ [-10,38,-245], 1 ],
  [ [2599,-1,551,-1,61991], -1 ],
  [ [-256], 12 ],
  [ [-48,2600,-7,1576,-26,1576,-153], -1 ],
  [ [-48,553,-206], -1 ],
  [ [2602,-1,554,-1,61994], -1 ],
  [ [-256], 13 ],
  [ [-256], 14 ],
  [ [-256], 21 ],
  [ [-256], 20 ],
  [ [-256], 11 ],
  [ [-48,16,2321,-198], -1 ],
  [ [-65,43,-2,44,45,-2,46,47,-2,48,-2,49,-17,43,-2,44,45,-2,46,47,-2,48,-2,49,-144], -1 ],
  [ [-256], 19 ],
  [ [-48,2610,-198], 19 ],
  [ [-256], 10 ],
  [ [2611,-1,563,-1,62003], 2 ],
  [ [-256], 5 ],
  [ [-48,2612,-7,820,53,2356,54,1076,55,1844,-4,52,-1,820,53,2356,54,1076,55,1844,-133], 8 ],
  [ [-48,2612,-7,564,56,52,57,820,58,820,59,60,52,61,52,62,820,63,1076,-4,52,-1,564,56,52,57,820,58,820,59,60,52,61,52,62,820,63,1076,-133], 22 ],
  [ [-48,2612,-7,2868,64,65,564,66,2612,-4,52,-1,2868,64,65,564,66,2612,-133], 22 ],
  [ [-48,2612,-7,1076,67,5428,-4,52,-1,1076,67,5428,-133], 22 ],
  [ [-48,2612,-7,3636,68,2868,-4,52,-1,3636,68,2868,-133], 22 ],
  [ [-48,2612,-7,6708,-4,52,-1,6708,-133], 22 ],
  [ [-48,2612,-7,3380,69,3124,-4,52,-1,3380,69,3124,-133], 22 ],
  [ [-48,2612,-7,3124,70,1332,71,1844,-4,52,-1,3124,70,1332,71,1844,-133], 22 ],
  [ [-48,2612,-7,820,72,3636,73,1844,-4,52,-1,820,72,3636,73,1844,-133], 22 ],
  [ [-48,2612,-7,3636,74,2868,-4,52,-1,3636,74,2868,-133], 22 ],
  [ [-48,2612,-7,4404,75,2100,-4,52,-1,4404,75,2100,-133], 22 ],
  [ [-48,2612,-7,1844,76,820,77,3636,-4,52,-1,1844,76,820,77,3636,-133], 22 ],
  [ [-48,2612,-7,3636,78,1076,79,1588,-4,52,-1,3636,78,1076,79,1588,-133], 22 ],
  [ [-48,2612,-7,52,80,564,81,3636,82,1588,-4,52,-1,52,80,564,81,3636,82,1588,-133], 22 ],
  [ [-48,2612,-7,83,4404,84,1076,85,86,52,-4,52,-1,83,4404,84,1076,85,86,52,-133], 22 ],
  [ [-48,2612,-7,6708,-4,52,-1,6708,-133], 9 ],
  [ [-48,2612,-7,6708,-4,52,-1,6708,-133], 9 ],
  [ [-256], 1 ],
  [ [2599,-1,551,-1,5159,87,56615], -1 ],
  [ [-48,2600,-7,1576,-26,1576,-153], 18 ],
  [ [-48,553,-206], 17 ],
  [ [-39,88,-216], -1 ],
  [ [-83,89,-31,89,-140], -1 ],
  [ [-66,90,-16,91,-3,92,-10,90,-16,91,-3,92,-136], -1 ],
  [ [-81,93,-31,93,-142], -1 ],
  [ [-73,94,-31,94,-150], 7 ],
  [ [-78,95,-31,95,-145], -1 ],
  [ [-79,96,-31,96,-144], 6 ],
  [ [-82,97,-31,97,-141], -1 ],
  [ [-48,2610,-198], 19 ],
  [ [2611,-1,563,-1,62003], 2 ],
  [ [-48,2612,-7,6708,-4,52,-1,6708,-133], 22 ],
  [ [-48,2612,-7,564,98,5940,-4,52,-1,564,98,5940,-133], 22 ],
  [ [-48,2612,-7,820,99,5684,-4,52,-1,820,99,5684,-133], 22 ],
  [ [-48,2612,-7,2868,100,3636,-4,52,-1,2868,100,3636,-133], 22 ],
  [ [-48,2612,-7,564,101,3892,102,1844,-4,52,-1,564,101,3892,102,1844,-133], 22 ],
  [ [-48,2612,-7,4148,103,2356,-4,52,-1,4148,103,2356,-133], 22 ],
  [ [-48,2612,-7,4916,104,1588,-4,52,-1,4916,104,1588,-133], 22 ],
  [ [-48,2612,-7,2100,105,4404,-4,52,-1,2100,105,4404,-133], 22 ],
  [ [-48,2612,-7,1076,106,5428,-4,52,-1,1076,106,5428,-133], 22 ],
  [ [-48,2612,-7,2868,107,3636,-4,52,-1,2868,107,3636,-133], 22 ],
  [ [-48,2612,-7,2612,108,3892,-4,52,-1,2612,108,3892,-133], 22 ],
  [ [-48,2612,-7,564,109,3892,110,1844,-4,52,-1,564,109,3892,110,1844,-133], 22 ],
  [ [-48,2612,-7,564,111,112,1076,113,3124,114,1076,-4,52,-1,564,111,112,1076,113,3124,114,1076,-133], 22 ],
  [ [-48,2612,-7,3892,115,2612,-4,52,-1,3892,115,2612,-133], 22 ],
  [ [-48,2612,-7,5940,116,117,52,-4,52,-1,5940,116,117,52,-133], 22 ],
  [ [-48,2612,-7,564,118,5172,119,120,52,-4,52,-1,564,118,5172,119,120,52,-133], 22 ],
  [ [-48,2612,-7,4404,121,2100,-4,52,-1,4404,121,2100,-133], 22 ],
  [ [-48,2612,-7,564,122,5172,123,124,52,-4,52,-1,564,122,5172,123,124,52,-133], 22 ],
  [ [-48,2612,-7,3892,125,2612,-4,52,-1,3892,125,2612,-133], 22 ],
  [ [-48,2612,-7,4404,126,2100,-4,52,-1,4404,126,2100,-133], 22 ],
  [ [-48,2612,-7,127,5684,128,129,52,-4,52,-1,127,5684,128,129,52,-133], 22 ],
  [ [-48,2612,-7,4404,130,2100,-4,52,-1,4404,130,2100,-133], 22 ],
  [ [-48,2612,-7,3892,131,2612,-4,52,-1,3892,131,2612,-133], 22 ],
  [ [-48,2612,-7,132,6452,-4,52,-1,132,6452,-133], 22 ],
  [ [-48,2612,-7,133,3636,134,2612,-4,52,-1,133,3636,134,2612,-133], 22 ],
  [ [-48,2612,-7,135,3636,136,2612,-4,52,-1,135,3636,136,2612,-133], 22 ],
  [ [-48,2612,-7,2868,137,1332,138,2100,-4,52,-1,2868,137,1332,138,2100,-133], 22 ],
  [ [-48,2612,-7,2100,139,2356,140,1844,-4,52,-1,2100,139,2356,140,1844,-133], 22 ],
  [ [-48,2612,-7,564,141,5940,-4,52,-1,564,141,5940,-133], 22 ],
  [ [-48,2612,-7,564,142,143,1076,144,4404,-4,52,-1,564,142,143,1076,144,4404,-133], 22 ],
  [ [-48,2612,-7,145,5684,146,147,52,-4,52,-1,145,5684,146,147,52,-133], 22 ],
  [ [-48,2612,-7,5940,148,149,52,-4,52,-1,5940,148,149,52,-133], 22 ],
  [ [-48,2612,-7,5940,150,564,-4,52,-1,5940,150,564,-133], 22 ],
  [ [-48,2612,-7,151,4404,152,1844,-4,52,-1,151,4404,152,1844,-133], 22 ],
  [ [-48,2612,-7,153,6452,-4,52,-1,153,6452,-133], 22 ],
  [ [2599,-1,551,-1,5159,87,56615], 16 ],
  [ [-256], 15 ],
  [ [-67,154,-31,154,-156], -1 ],
  [ [-256], 4 ],
  [ [-256], 4 ],
  [ [-256], 4 ],
  [ [-85,155,-31,155,-138], 5 ],
  [ [-71,156,-31,156,-152], -1 ],
  [ [-67,157,-31,157,-156], -1 ],
  [ [-87,158,-31,158,-136], -1 ],
  [ [-71,159,-31,159,-152], -1 ],
  [ [-48,2612,-7,6708,-4,52,-1,6708,-133], 3 ],
  [ [-48,2612,-7,6708,-4,52,-1,6708,-133], 3 ],
  [ [-48,2612,-7,6708,-4,52,-1,6708,-133], 3 ],
  [ [-48,2612,-7,6708,-4,52,-1,6708,-133], 3 ],
  [ [-48,2612,-7,6708,-4,52,-1,6708,-133], 3 ],
  [ [-48,2612,-7,6708,-4,52,-1,6708,-133], 3 ],
  [ [-48,2612,-7,6708,-4,52,-1,6708,-133], 3 ],
  [ [-48,2612,-7,6708,-4,52,-1,6708,-133], 3 ],
  [ [-48,2612,-7,6708,-4,52,-1,6708,-133], 3 ],
  [ [-48,2612,-7,6708,-4,52,-1,6708,-133], 3 ],
  [ [-48,2612,-7,6708,-4,52,-1,6708,-133], 3 ],
  [ [-48,2612,-7,6708,-4,52,-1,6708,-133], 3 ],
  [ [-48,2612,-7,6708,-4,52,-1,6708,-133], 3 ],
  [ [-48,2612,-7,6708,-4,52,-1,6708,-133], 3 ],
  [ [-48,2612,-7,6708,-4,52,-1,6708,-133], 3 ],
  [ [-48,2612,-7,6708,-4,52,-1,6708,-133], 3 ],
  [ [-48,2612,-7,6708,-4,52,-1,6708,-133], 3 ],
  [ [-48,2612,-7,6708,-4,52,-1,6708,-133], 3 ],
  [ [-48,2612,-7,6708,-4,52,-1,6708,-133], 3 ],
  [ [-48,2612,-7,6708,-4,52,-1,6708,-133], 3 ],
  [ [-48,2612,-7,6708,-4,52,-1,6708,-133], 3 ],
  [ [-48,2612,-7,6708,-4,52,-1,6708,-133], 3 ],
  [ [-48,2612,-7,6708,-4,52,-1,6708,-133], 3 ],
  [ [-48,2612,-7,6708,-4,52,-1,6708,-133], 3 ],
  [ [-48,2612,-7,6708,-4,52,-1,6708,-133], 3 ],
  [ [-48,2612,-7,6708,-4,52,-1,6708,-133], 3 ],
  [ [-48,2612,-7,6708,-4,52,-1,6708,-133], 3 ],
  [ [-48,2612,-7,6708,-4,52,-1,6708,-133], 3 ],
  [ [-48,2612,-7,6708,-4,52,-1,6708,-133], 3 ],
  [ [-48,2612,-7,6708,-4,52,-1,6708,-133], 3 ],
  [ [-48,2612,-7,6708,-4,52,-1,6708,-133], 3 ],
  [ [-48,2612,-7,6708,-4,52,-1,6708,-133], 3 ],
  [ [-48,2612,-7,6708,-4,52,-1,6708,-133], 3 ],
  [ [-48,2612,-7,6708,-4,52,-1,6708,-133], 3 ],
  [ [-48,2612,-7,6708,-4,52,-1,6708,-133], 3 ],
  [ [-48,2612,-7,6708,-4,52,-1,6708,-133], 3 ],
  [ [-48,2612,-7,6708,-4,52,-1,6708,-133], 3 ],
  [ [-48,2612,-7,6708,-4,52,-1,6708,-133], 3 ],
  [ [-48,2612,-7,6708,-4,52,-1,6708,-133], 3 ],
  [ [-48,2612,-7,6708,-4,52,-1,6708,-133], 3 ],
  [ [-48,2612,-7,6708,-4,52,-1,6708,-133], 3 ],
  [ [-48,2612,-7,6708,-4,52,-1,6708,-133], 3 ],
  [ [-48,2612,-7,6708,-4,52,-1,6708,-133], 3 ],
  [ [-48,2612,-7,6708,-4,52,-1,6708,-133], 3 ],
  [ [-48,2612,-7,6708,-4,52,-1,6708,-133], 3 ],
  [ [-48,2612,-7,6708,-4,52,-1,6708,-133], 3 ],
  [ [-48,2612,-7,6708,-4,52,-1,6708,-133], 3 ],
  [ [-48,2612,-7,6708,-4,52,-1,6708,-133], 3 ],
  [ [-48,2612,-7,6708,-4,52,-1,6708,-133], 3 ],
  [ [-48,2612,-7,6708,-4,52,-1,6708,-133], 3 ],
  [ [-48,2612,-7,6708,-4,52,-1,6708,-133], 3 ],
  [ [-48,2612,-7,6708,-4,52,-1,6708,-133], 3 ],
  [ [-48,2612,-7,6708,-4,52,-1,6708,-133], 3 ],
  [ [-48,2612,-7,6708,-4,52,-1,6708,-133], 3 ],
  [ [-48,2612,-7,6708,-4,52,-1,6708,-133], 3 ],
  [ [-48,2612,-7,6708,-4,52,-1,6708,-133], 3 ],
  [ [-73,160,-31,160,-150], -1 ],
  [ [-256], 5 ],
  [ [-72,161,-31,161,-151], -1 ],
  [ [-76,162,-31,162,-147], -1 ],
  [ [-256], 6 ],
  [ [-256], 4 ],
  [ [-73,163,-31,163,-150], -1 ],
  [ [-256], 7 ],
  [ [-85,164,-31,164,-138], -1 ],
  [ [-256], 4 ],
  [ [-68,165,-31,165,-155], -1 ],
  [ [-69,166,-31,166,-154], -1 ],
  [ [-256], 4 ],
];

class Lexer {
    constructor() {
        this.runner = new DFARunner(table);
        this.text = "";
    }

    get text() {
        return this._text;
    }

    set text(value) {
        this._text = value;
        this.offset = 0;
        this.length = value.length;
        this.column = 1;
        this.line = 1;
    }

    next() {
        var result = null;
                
        if (this.offset < this.length) {
            result = this.runner.next(this._text, this.offset, this.length);

            if (result !== null) {
                result.token = tokens[result.type];
                
                result.line = this.line;
                result.column = this.column;

                // update current line and column
                if (result.token.type == "eol") {
                    this.line++;
                    this.column = 1;
                }
                else {
                    this.column += result.endingOffset - result.startingOffset;
                }

                this.offset = result.endingOffset;
            }
        }
        
        return result;
    }
}

module.exports = Lexer;
